<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéõÔ∏è Painel Administrativo - XCafe Widget SaaS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- CSS Unificado -->
    <link href="css/app.css" rel="stylesheet">
</head>
<body>
    <!-- Bot√£o do Menu Lateral -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar de Administra√ß√£o -->
    <nav class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-header">
            <h4 class="text-white mb-0">
                <i class="fas fa-cog me-2"></i>
                Admin Panel
            </h4>
            <small class="text-light opacity-75" id="userInfo">Carregando...</small>
        </div>
        
        <ul class="admin-nav">
            <li class="admin-nav-item">
                <a href="#dashboard" class="admin-nav-link" data-section="dashboard">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Dashboard
                </a>
            </li>
            <li class="admin-nav-item" data-auth="admin">
                <a href="#admins" class="admin-nav-link" data-section="admins">
                    <i class="fas fa-users-cog me-2"></i>
                    Administradores
                </a>
            </li>
            <li class="admin-nav-item">
                <a href="#widgets" class="admin-nav-link" data-section="widgets">
                    <i class="fas fa-puzzle-piece me-2"></i>
                    Widgets
                </a>
            </li>
            <li class="admin-nav-item" data-auth="admin">
                <a href="#analytics" class="admin-nav-link" data-section="analytics">
                    <i class="fas fa-chart-line me-2"></i>
                    Analytics
                </a>
            </li>
            <li class="admin-nav-item" data-auth="super-admin">
                <a href="#system" class="admin-nav-link" data-section="system">
                    <i class="fas fa-server me-2"></i>
                    Sistema
                </a>
            </li>
            <li class="admin-nav-item">
                <a href="#" class="admin-nav-link" onclick="auth.logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    Sair
                </a>
            </li>
        </ul>
    </nav>

    <!-- Conte√∫do Principal -->
    <main class="admin-content" id="adminContent">
        <!-- Dashboard Section -->
        <section id="section-dashboard" class="admin-section active">
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
                        <p class="text-muted">Vis√£o geral do sistema</p>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="dashboard-stats" id="dashboardStats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalWidgets">0</div>
                        <div class="stat-label">Widgets Ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalAdmins">0</div>
                        <div class="stat-label">Administradores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalTransactions">0</div>
                        <div class="stat-label">Transa√ß√µes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemUptime">Online</div>
                        <div class="stat-label">Status do Sistema</div>
                    </div>
                </div>

                <!-- Activity Feed -->
                <div class="row mt-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Atividade Recente</h5>
                            </div>
                            <div class="card-body">
                                <div id="activityFeed">
                                    <p class="text-muted">Carregando atividades...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Sistema</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="loadSystemStats()">
                                        <i class="fas fa-sync me-1"></i>
                                        Atualizar Stats
                                    </button>
                                    <button class="btn btn-outline-info" onclick="checkHealth()">
                                        <i class="fas fa-heartbeat me-1"></i>
                                        Health Check
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Administradores Section -->
        <section id="section-admins" class="admin-section" data-auth="admin">
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="fas fa-users-cog me-2"></i>Administradores</h1>
                        <p class="text-muted">Gerenciar administradores do sistema</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" onclick="showCreateAdminModal()">
                            <i class="fas fa-plus me-1"></i>
                            Novo Admin
                        </button>
                    </div>
                </div>

                <!-- Lista de Admins -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="adminsTable">
                                <thead>
                                    <tr>
                                        <th>Endere√ßo</th>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Departamento</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="adminsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Widgets Section -->
        <section id="section-widgets" class="admin-section">
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="fas fa-puzzle-piece me-2"></i>Widgets</h1>
                        <p class="text-muted">Gerenciar widgets do sistema</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" onclick="showCreateWidgetModal()">
                            <i class="fas fa-plus me-1"></i>
                            Novo Widget
                        </button>
                    </div>
                </div>

                <!-- Widget Grid -->
                <div class="widget-grid" id="widgetsGrid">
                    <div class="text-center">
                        <p class="text-muted">Carregando widgets...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="section-analytics" class="admin-section" data-auth="admin">
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="fas fa-chart-line me-2"></i>Analytics</h1>
                        <p class="text-muted">An√°lises e relat√≥rios do sistema</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Widgets por Tipo</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="widgetTypeChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Transa√ß√µes por Dia</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="transactionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sistema Section -->
        <section id="section-system" class="admin-section" data-auth="super-admin">
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="fas fa-server me-2"></i>Sistema</h1>
                        <p class="text-muted">Configura√ß√µes avan√ßadas do sistema</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">‚ö†Ô∏è Zona de Perigo</h5>
                            </div>
                            <div class="card-body">
                                <p>A√ß√µes irrevers√≠veis que afetam todo o sistema.</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-danger" onclick="confirmSystemReset()">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Reset Completo do Sistema
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Informa√ß√µes do Sistema</h5>
                            </div>
                            <div class="card-body">
                                <div id="systemInfo">
                                    <p class="text-muted">Carregando informa√ß√µes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal: Criar Admin -->
    <div class="modal" id="createAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Administrador</h3>
                <button class="modal-close" onclick="closeModal('createAdminModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createAdminForm">
                    <div class="form-group">
                        <label class="form-label">Endere√ßo da Wallet</label>
                        <input type="text" class="form-control" id="adminAddress" placeholder="0x..." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nome</label>
                        <input type="text" class="form-control" id="adminName" placeholder="Nome do administrador" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Departamento</label>
                        <input type="text" class="form-control" id="adminDepartment" placeholder="Departamento">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Usu√°rio</label>
                        <select class="form-control" id="adminUserType" required>
                            <option value="Moderator">Moderator</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createAdminModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="createAdmin()">Criar Admin</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript Unificado -->
    <script src="js/shared/web3.js"></script>
    <script src="js/shared/api.js"></script>
    <script src="js/shared/auth.js"></script>
    <script src="js/xcafe-app.js"></script>

    <script>
        // ============================================================================
        // ADMIN PANEL CONTROLLER
        // ============================================================================
        
        class AdminPanel {
            constructor() {
                this.currentSection = 'dashboard';
                this.init();
            }

            async init() {
                // Verificar autentica√ß√£o
                if (!auth.requireAdmin()) {
                    return;
                }

                this.setupEventListeners();
                await this.loadInitialData();
                this.updateUI();
            }

            setupEventListeners() {
                // Toggle sidebar
                document.getElementById('sidebarToggle').onclick = () => {
                    document.getElementById('adminSidebar').classList.toggle('active');
                    document.getElementById('adminContent').classList.toggle('sidebar-active');
                };

                // Navigation
                document.querySelectorAll('[data-section]').forEach(link => {
                    link.onclick = (e) => {
                        e.preventDefault();
                        this.showSection(link.dataset.section);
                    };
                });

                // Auth status listener
                window.addEventListener('authStatusChanged', () => {
                    this.updateUserInfo();
                });
            }

            showSection(sectionName) {
                // Hide all sections
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.remove('active');
                });

                // Show target section
                const targetSection = document.getElementById(`section-${sectionName}`);
                if (targetSection) {
                    targetSection.classList.add('active');
                    this.currentSection = sectionName;
                }

                // Update navigation
                document.querySelectorAll('.admin-nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

                // Load section data
                this.loadSectionData(sectionName);
            }

            async loadInitialData() {
                await this.loadDashboardStats();
                this.updateUserInfo();
            }

            async loadSectionData(section) {
                switch (section) {
                    case 'dashboard':
                        await this.loadDashboardStats();
                        break;
                    case 'admins':
                        await this.loadAdmins();
                        break;
                    case 'widgets':
                        await this.loadWidgets();
                        break;
                    case 'analytics':
                        await this.loadAnalytics();
                        break;
                    case 'system':
                        await this.loadSystemInfo();
                        break;
                }
            }

            async loadDashboardStats() {
                try {
                    const stats = await api.system.stats();
                    
                    document.getElementById('totalAdmins').textContent = stats.totalAdmins || 0;
                    document.getElementById('totalWidgets').textContent = stats.totalWidgets || 0;
                    document.getElementById('totalTransactions').textContent = stats.totalTransactions || 0;
                    document.getElementById('systemUptime').textContent = stats.systemInitialized ? 'Online' : 'Inicializando';
                    
                } catch (error) {
                    console.error('Erro ao carregar stats:', error);
                }
            }

            async loadAdmins() {
                try {
                    const admins = await api.admin.list();
                    this.renderAdminsTable(admins);
                } catch (error) {
                    console.error('Erro ao carregar admins:', error);
                }
            }

            renderAdminsTable(admins) {
                const tbody = document.getElementById('adminsTableBody');
                
                if (!admins || admins.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum administrador encontrado</td></tr>';
                    return;
                }

                tbody.innerHTML = admins.map(admin => `
                    <tr>
                        <td>
                            <code>${utils.formatAddress(admin.address)}</code>
                        </td>
                        <td>${admin.name || 'N/A'}</td>
                        <td>
                            <span class="badge bg-primary">${admin.userType}</span>
                        </td>
                        <td>${admin.department || 'N/A'}</td>
                        <td>
                            <span class="badge ${admin.active ? 'bg-success' : 'bg-danger'}">
                                ${admin.active ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            ${auth.isSuperAdmin() || admin.userType !== 'Super Admin' ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteAdmin('${admin.address}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            }

            updateUserInfo() {
                const userInfo = document.getElementById('userInfo');
                if (auth.isAuthenticated()) {
                    const user = auth.getUser();
                    userInfo.innerHTML = `
                        <div>${utils.formatAddress(user.address)}</div>
                        <div class="text-warning">${user.userType}</div>
                    `;
                }
            }

            updateUI() {
                // A fun√ß√£o updateAuthUI do auth.js j√° cuida disso
                authManager.updateAuthUI();
            }
        }

        // ============================================================================
        // GLOBAL FUNCTIONS
        // ============================================================================

        let adminPanel;

        async function loadSystemStats() {
            await adminPanel.loadDashboardStats();
            adminPanel.showNotification('Stats atualizadas!', 'success');
        }

        async function checkHealth() {
            try {
                const health = await api.system.health();
                adminPanel.showNotification(`Sistema ${health.status}: ${health.service}`, 'info');
            } catch (error) {
                adminPanel.showNotification('Erro ao verificar health', 'danger');
            }
        }

        function showCreateAdminModal() {
            document.getElementById('createAdminModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function createAdmin() {
            const form = document.getElementById('createAdminForm');
            const formData = new FormData(form);
            
            const adminData = {
                address: document.getElementById('adminAddress').value,
                name: document.getElementById('adminName').value,
                department: document.getElementById('adminDepartment').value,
                userType: document.getElementById('adminUserType').value
            };

            // Validar dados
            const errors = utils.validateRequired({
                'Endere√ßo': adminData.address,
                'Nome': adminData.name,
                'Tipo': adminData.userType
            });

            if (errors.length > 0) {
                alert('Erros:\n' + errors.join('\n'));
                return;
            }

            if (!utils.validateWallet(adminData.address)) {
                alert('Endere√ßo de wallet inv√°lido');
                return;
            }

            try {
                const result = await api.admin.create(adminData);
                
                if (result.success) {
                    closeModal('createAdminModal');
                    form.reset();
                    await adminPanel.loadAdmins();
                    adminPanel.showNotification('Admin criado com sucesso!', 'success');
                } else {
                    alert('Erro: ' + result.error);
                }
            } catch (error) {
                alert('Erro ao criar admin: ' + error.message);
            }
        }

        async function confirmDeleteAdmin(address) {
            if (confirm(`Tem certeza que deseja remover o admin ${utils.formatAddress(address)}?`)) {
                try {
                    await api.admin.delete(address);
                    await adminPanel.loadAdmins();
                    adminPanel.showNotification('Admin removido!', 'success');
                } catch (error) {
                    alert('Erro ao remover admin: ' + error.message);
                }
            }
        }

        async function confirmSystemReset() {
            const confirm1 = confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° resetar COMPLETAMENTE o sistema!');
            if (!confirm1) return;
            
            const confirm2 = confirm('üö® √öLTIMA CHANCE: Todos os dados ser√£o perdidos. Continuar?');
            if (!confirm2) return;

            try {
                await api.system.reset();
                alert('Sistema resetado! Redirecionando...');
                window.location.href = '/auth.html';
            } catch (error) {
                alert('Erro ao resetar sistema: ' + error.message);
            }
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        document.addEventListener('DOMContentLoaded', () => {
            adminPanel = new AdminPanel();
        });

        // CSS adicional para as se√ß√µes
        const style = document.createElement('style');
        style.textContent = `
            .admin-section {
                display: none;
                animation: fadeIn 0.3s ease-in;
            }
            
            .admin-section.active {
                display: block;
            }
            
            .stat-card:hover {
                transform: translateY(-2px);
                transition: transform 0.2s;
            }
            
            @media (max-width: 768px) {
                .admin-sidebar {
                    transform: translateX(-100%);
                }
                
                .admin-sidebar.active {
                    transform: translateX(0);
                }
                
                .admin-content {
                    margin-left: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
