/**
 * üåê WEB3 MANAGER - Sistema de Conex√£o Blockchain
 * 
 * üìã RESPONSABILIDADES:
 * - Conectar/desconectar MetaMask
 * - Gerenciar estado da carteira
 * - Interagir com contratos inteligentes
 * - Monitorar mudan√ßas de rede/conta
 * 
 * üîß DEPEND√äNCIAS:
 * - MetaMask ou carteira compat√≠vel
 * - Web3 Provider
 * 
 * üéØ USO:
 * - const web3 = new Web3Manager();
 * - await web3.connectWallet();
 * - const balance = await web3.getBalance();
 */

class Web3Manager {
    constructor() {
        this.provider = null;
        this.signer = null;
        this.currentAccount = null;
        this.currentNetwork = null;
        this.isConnected = false;
        
        // Contratos suportados
        this.contracts = {};
        
        // Redes suportadas
        this.supportedNetworks = {
            1: { name: 'Ethereum Mainnet', symbol: 'ETH', rpc: 'https://eth-mainnet.g.alchemy.com/v2/', explorer: 'https://etherscan.io' },
            56: { name: 'BSC Mainnet', symbol: 'BNB', rpc: 'https://bsc-dataseed.binance.org/', explorer: 'https://bscscan.com' },
            97: { name: 'BSC Testnet', symbol: 'tBNB', rpc: 'https://data-seed-prebsc-1-s1.binance.org:8545/', explorer: 'https://testnet.bscscan.com' },
            137: { name: 'Polygon', symbol: 'MATIC', rpc: 'https://polygon-rpc.com/', explorer: 'https://polygonscan.com' },
            80001: { name: 'Polygon Mumbai', symbol: 'MATIC', rpc: 'https://rpc-mumbai.maticvigil.com/', explorer: 'https://mumbai.polygonscan.com' }
        };

        this.init();
    }

    // ==================== INICIALIZA√á√ÉO ====================
    
    /**
     * Inicializa o Web3Manager
     */
    async init() {
        try {
            console.log('üåê Inicializando Web3Manager...');
            
            // Verificar se MetaMask est√° dispon√≠vel
            if (!this.isMetaMaskAvailable()) {
                console.warn('‚ö†Ô∏è MetaMask n√£o detectado');
                return;
            }

            // Configurar event listeners
            this.setupEventListeners();
            
            // Verificar se j√° est√° conectado
            await this.checkExistingConnection();
            
            console.log('‚úÖ Web3Manager inicializado');
        } catch (error) {
            console.error('‚ùå Erro ao inicializar Web3Manager:', error);
        }
    }

    /**
     * Verifica se MetaMask est√° dispon√≠vel
     */
    isMetaMaskAvailable() {
        return typeof window.ethereum !== 'undefined';
    }

    /**
     * Configura event listeners para mudan√ßas de conta/rede
     */
    setupEventListeners() {
        if (!window.ethereum) return;

        // Mudan√ßa de conta
        window.ethereum.on('accountsChanged', (accounts) => {
            console.log('üì± Conta alterada:', accounts);
            this.handleAccountsChanged(accounts);
        });

        // Mudan√ßa de rede
        window.ethereum.on('chainChanged', (chainId) => {
            console.log('üîó Rede alterada:', chainId);
            this.handleChainChanged(chainId);
        });

        // Conex√£o/desconex√£o
        window.ethereum.on('connect', (connectInfo) => {
            console.log('üîå Conectado:', connectInfo);
        });

        window.ethereum.on('disconnect', (error) => {
            console.log('üîå Desconectado:', error);
            this.handleDisconnect();
        });
    }

    // ==================== CONEX√ÉO ====================
    
    /**
     * Conecta √† carteira MetaMask
     */
    async connectWallet() {
        try {
            if (!this.isMetaMaskAvailable()) {
                throw new Error('MetaMask n√£o detectado. Instale a extens√£o MetaMask.');
            }

            console.log('üîå Conectando carteira...');
            
            // Solicitar conex√£o
            const accounts = await window.ethereum.request({
                method: 'eth_requestAccounts'
            });

            if (accounts.length === 0) {
                throw new Error('Nenhuma conta autorizada');
            }

            // Configurar provider
            this.provider = window.ethereum;
            this.currentAccount = accounts[0];
            this.isConnected = true;

            // Obter informa√ß√µes da rede
            await this.updateNetworkInfo();

            // Salvar no localStorage
            this.saveConnectionState();

            console.log('‚úÖ Carteira conectada:', this.currentAccount);
            
            // Disparar evento customizado
            this.dispatchEvent('walletConnected', {
                account: this.currentAccount,
                network: this.currentNetwork
            });

            return this.currentAccount;
            
        } catch (error) {
            console.error('‚ùå Erro ao conectar carteira:', error);
            throw error;
        }
    }

    /**
     * Desconecta da carteira - Desconex√£o REAL do MetaMask
     */
    async disconnect() {
        try {
            console.log('üîå Iniciando desconex√£o real...');

            // Tentar desconex√£o real via MetaMask API
            if (window.ethereum && window.ethereum.selectedAddress) {
                try {
                    // M√©todo 1: wallet_revokePermissions (mais recente)
                    if (window.ethereum.request) {
                        await window.ethereum.request({
                            method: "wallet_revokePermissions",
                            params: [{
                                eth_accounts: {}
                            }]
                        });
                        console.log('‚úÖ Permiss√µes revogadas via wallet_revokePermissions');
                    }
                } catch (revokeError) {
                    console.log('‚ö†Ô∏è wallet_revokePermissions n√£o suportado, tentando m√©todo alternativo...');
                    
                    // M√©todo 2: Solicitar desconex√£o via wallet_requestPermissions com contas vazias
                    try {
                        await window.ethereum.request({
                            method: 'wallet_requestPermissions',
                            params: [{ eth_accounts: {} }]
                        });
                        
                        // Depois cancelar/rejeitar para for√ßar desconex√£o
                        const accounts = await window.ethereum.request({
                            method: 'eth_accounts'
                        });
                        
                        if (accounts.length > 0) {
                            console.log('‚ö†Ô∏è Usu√°rio ainda autorizado, limpando estado local apenas');
                        }
                    } catch (altError) {
                        console.log('‚ö†Ô∏è M√©todos de desconex√£o n√£o suportados, limpando estado local');
                    }
                }
            }

            // Limpar estado local independentemente
            this.provider = null;
            this.signer = null;
            this.currentAccount = null;
            this.currentNetwork = null;
            this.isConnected = false;

            // Limpar localStorage
            this.clearConnectionState();

            // For√ßar reload da p√°gina para garantir limpeza completa
            console.log('ÔøΩ Recarregando p√°gina para garantir desconex√£o completa...');
            
            // Disparar evento antes do reload
            this.dispatchEvent('walletDisconnected');
            
            // Pequeno delay para eventos processarem
            setTimeout(() => {
                window.location.reload();
            }, 500);
            
        } catch (error) {
            console.error('‚ùå Erro ao desconectar:', error);
            
            // Mesmo com erro, limpar estado local
            this.provider = null;
            this.signer = null;
            this.currentAccount = null;
            this.currentNetwork = null;
            this.isConnected = false;
            this.clearConnectionState();
            this.dispatchEvent('walletDisconnected');
        }
    }

    /**
     * Verifica conex√£o existente
     */
    async checkExistingConnection() {
        try {
            if (!this.isMetaMaskAvailable()) return false;

            const accounts = await window.ethereum.request({
                method: 'eth_accounts'
            });

            if (accounts.length > 0) {
                this.provider = window.ethereum;
                this.currentAccount = accounts[0];
                this.isConnected = true;
                await this.updateNetworkInfo();
                
                console.log('üîÑ Conex√£o existente detectada:', this.currentAccount);
                return true;
            }

            return false;
        } catch (error) {
            console.error('‚ùå Erro ao verificar conex√£o:', error);
            return false;
        }
    }

    // ==================== INFORMA√á√ïES DA REDE ====================
    
    /**
     * Atualiza informa√ß√µes da rede atual
     */
    async updateNetworkInfo() {
        try {
            const chainId = await window.ethereum.request({
                method: 'eth_chainId'
            });

            const networkId = parseInt(chainId, 16);
            this.currentNetwork = {
                chainId: chainId,
                networkId: networkId,
                ...this.supportedNetworks[networkId]
            };

            return this.currentNetwork;
        } catch (error) {
            console.error('‚ùå Erro ao obter info da rede:', error);
            return null;
        }
    }

    /**
     * Verifica se a rede atual √© suportada
     */
    isNetworkSupported() {
        return this.currentNetwork && this.supportedNetworks[this.currentNetwork.networkId];
    }

    /**
     * Solicita mudan√ßa de rede
     */
    async switchNetwork(networkId) {
        try {
            const network = this.supportedNetworks[networkId];
            if (!network) {
                throw new Error('Rede n√£o suportada');
            }

            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: `0x${networkId.toString(16)}` }]
            });

        } catch (error) {
            console.error('‚ùå Erro ao trocar rede:', error);
            throw error;
        }
    }

    // ==================== DADOS DA CARTEIRA ====================
    
    /**
     * Obt√©m saldo da carteira atual
     */
    async getBalance(address = null) {
        try {
            const account = address || this.currentAccount;
            if (!account) throw new Error('Nenhuma conta conectada');

            const balance = await window.ethereum.request({
                method: 'eth_getBalance',
                params: [account, 'latest']
            });

            return {
                wei: balance,
                eth: parseFloat(parseInt(balance, 16) / Math.pow(10, 18)).toFixed(6)
            };
        } catch (error) {
            console.error('‚ùå Erro ao obter saldo:', error);
            throw error;
        }
    }

    /**
     * Obt√©m conta atual
     */
    getCurrentAccount() {
        return this.currentAccount;
    }

    /**
     * Obt√©m rede atual
     */
    getCurrentNetwork() {
        return this.currentNetwork;
    }

    // ==================== EVENT HANDLERS ====================
    
    /**
     * Manipula mudan√ßa de contas
     */
    async handleAccountsChanged(accounts) {
        if (accounts.length === 0) {
            // Usu√°rio desconectou
            await this.disconnect();
        } else if (accounts[0] !== this.currentAccount) {
            // Mudou de conta
            this.currentAccount = accounts[0];
            this.saveConnectionState();
            
            this.dispatchEvent('accountChanged', {
                account: this.currentAccount
            });
        }
    }

    /**
     * Manipula mudan√ßa de rede
     */
    async handleChainChanged(chainId) {
        await this.updateNetworkInfo();
        this.saveConnectionState();
        
        this.dispatchEvent('networkChanged', {
            network: this.currentNetwork
        });
    }

    /**
     * Manipula desconex√£o
     */
    async handleDisconnect() {
        await this.disconnect();
    }

    // ==================== PERSIST√äNCIA ====================
    
    /**
     * Salva estado da conex√£o
     */
    saveConnectionState() {
        try {
            const state = {
                account: this.currentAccount,
                network: this.currentNetwork,
                isConnected: this.isConnected,
                timestamp: Date.now()
            };
            
            localStorage.setItem('web3_connection_state', JSON.stringify(state));
        } catch (error) {
            console.error('‚ùå Erro ao salvar estado:', error);
        }
    }

    /**
     * Limpa estado da conex√£o
     */
    clearConnectionState() {
        try {
            localStorage.removeItem('web3_connection_state');
        } catch (error) {
            console.error('‚ùå Erro ao limpar estado:', error);
        }
    }

    /**
     * Carrega estado da conex√£o
     */
    loadConnectionState() {
        try {
            const state = localStorage.getItem('web3_connection_state');
            return state ? JSON.parse(state) : null;
        } catch (error) {
            console.error('‚ùå Erro ao carregar estado:', error);
            return null;
        }
    }

    // ==================== EVENTOS CUSTOMIZADOS ====================
    
    /**
     * Dispara evento customizado
     */
    dispatchEvent(eventName, data = {}) {
        const event = new CustomEvent(`web3:${eventName}`, {
            detail: data
        });
        document.dispatchEvent(event);
    }

    // ==================== UTILIDADES ====================
    
    /**
     * Formata endere√ßo para exibi√ß√£o
     */
    formatAddress(address, length = 6) {
        if (!address) return '';
        return `${address.substring(0, length)}...${address.substring(address.length - 4)}`;
    }

    /**
     * Obt√©m URL do explorer para endere√ßo
     */
    getExplorerUrl(address) {
        if (!this.currentNetwork || !this.currentNetwork.explorer) return '#';
        return `${this.currentNetwork.explorer}/address/${address}`;
    }

    /**
     * Verifica se endere√ßo √© v√°lido
     */
    isValidAddress(address) {
        return /^0x[a-fA-F0-9]{40}$/.test(address);
    }

    /**
     * Obt√©m informa√ß√µes completas do estado
     */
    getState() {
        return {
            isConnected: this.isConnected,
            currentAccount: this.currentAccount,
            currentNetwork: this.currentNetwork,
            supportedNetworks: this.supportedNetworks,
            isMetaMaskAvailable: this.isMetaMaskAvailable()
        };
    }
}

// ==================== EXPORTA√á√ÉO ====================

// Disponibilizar globalmente
window.Web3Manager = Web3Manager;

// Log de carregamento
console.log('üì¶ Web3Manager carregado');

/**
 * üìö EXEMPLOS DE USO:
 * 
 * // Inicializar
 * const web3 = new Web3Manager();
 * 
 * // Conectar
 * await web3.connectWallet();
 * 
 * // Verificar estado
 * console.log(web3.getState());
 * 
 * // Event listeners
 * document.addEventListener('web3:walletConnected', (e) => {
 *     console.log('Carteira conectada:', e.detail);
 * });
 * 
 * document.addEventListener('web3:accountChanged', (e) => {
 *     console.log('Conta alterada:', e.detail);
 * });
 */
