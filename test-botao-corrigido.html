<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Bot√£o Visualizar - Corrigido</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body { 
            background: #0a0a0a; 
            color: white; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .btn-success { background: #28a745 !important; }
        .btn-warning { background: #fd7e14 !important; }
        #console-output {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">üîß Teste do Bot√£o Visualizar Contrato - CORRIGIDO</h1>
                
                <!-- Console de Debug -->
                <div class="test-section">
                    <h4><i class="bi bi-terminal me-2"></i>Console de Debug</h4>
                    <div id="console-output"></div>
                    <button class="btn btn-secondary btn-sm mt-2" onclick="clearConsole()">Limpar Console</button>
                </div>
                
                <!-- Se√ß√£o de Teste -->
                <div class="test-section">
                    <h4><i class="bi bi-play-circle me-2"></i>Testes Dispon√≠veis</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <button class="btn btn-primary w-100" onclick="testarFuncaoShowContract()">
                                <i class="bi bi-code me-2"></i>Testar showContractModal()
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-info w-100" onclick="verificarBotaoDOM()">
                                <i class="bi bi-search me-2"></i>Verificar Bot√£o no DOM
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-warning w-100" onclick="configurarBotao()">
                                <i class="bi bi-gear me-2"></i>Configurar Bot√£o
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-success w-100" onclick="testeCompleto()">
                                <i class="bi bi-check-all me-2"></i>Teste Completo
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o Original (Simulada) -->
                <div id="section-veri" class="test-section" style="display: block;">
                    <h4><i class="bi bi-shield-check me-2"></i>4. Verifica√ß√£o do Contrato</h4>
                    <p class="text-muted mb-3">Visualize e verifique seu contrato na blockchain</p>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <!-- Este √© o bot√£o que deve funcionar -->
                            <button id="view-contract-btn" class="btn btn-success w-100">
                                <i class="bi bi-eye me-2"></i>Visualizar Contrato
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="verify-contract-btn" class="btn btn-warning w-100">
                                <i class="bi bi-shield-check me-2"></i>Verificar Contrato
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Status -->
                <div class="test-section">
                    <h4><i class="bi bi-info-circle me-2"></i>Status</h4>
                    <div id="status-info" class="bg-dark p-3 rounded">
                        <p class="mb-1">üîÑ Aguardando teste...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/shared/common-utils.js"></script>
    <script>
        // ===== SISTEMA DE CONSOLE CUSTOMIZADO =====
        const originalConsole = { ...console };
        const consoleOutput = document.getElementById('console-output');
        
        function addToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const colors = {
                log: '#0f0',
                warn: '#ff0',
                error: '#f00',
                info: '#0ff'
            };
            
            consoleOutput.innerHTML += `<div style="color: ${colors[type] || '#0f0'}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Chamar console original tamb√©m
            originalConsole[type](...args);
        }
        
        console.log = (...args) => addToConsole('log', ...args);
        console.warn = (...args) => addToConsole('warn', ...args);
        console.error = (...args) => addToConsole('error', ...args);
        console.info = (...args) => addToConsole('info', ...args);
        
        function clearConsole() {
            consoleOutput.innerHTML = '';
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-info');
            const icons = {
                info: 'üîÑ',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            statusDiv.innerHTML = `<p class="mb-1">${icons[type]} ${message}</p>`;
        }
        
        // ===== SIMULAR APPSTATE E FUN√á√ïES =====
        window.AppState = {
            tokenData: {
                name: 'Test Token Corrigido',
                symbol: 'TSTFIX',
                totalSupply: '1000000',
                decimals: '18'
            },
            deployResult: {
                contractAddress: '0xABCDEF1234567890123456789012345678901234',
                sourceCode: `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

contract TestTokenCorrigido {
    string public name = "Test Token Corrigido";
    string public symbol = "TSTFIX";
    uint8 public decimals = 18;
    uint256 public totalSupply = 1000000 * 10**18;
    
    mapping(address => uint256) public balanceOf;
    
    event Transfer(address indexed from, address indexed to, uint256 value);
    
    constructor() {
        balanceOf[msg.sender] = totalSupply;
        emit Transfer(address(0), msg.sender, totalSupply);
    }
    
    function transfer(address to, uint256 value) public returns (bool) {
        require(balanceOf[msg.sender] >= value, "Saldo insuficiente");
        balanceOf[msg.sender] -= value;
        balanceOf[to] += value;
        emit Transfer(msg.sender, to, value);
        return true;
    }
    
    function approve(address spender, uint256 amount) public returns (bool) {
        // Implementa√ß√£o de approve aqui
        return true;
    }
}`
            },
            wallet: {
                network: { chainId: 97 }
            }
        };
        
        // ===== FUN√á√ÉO showContractModal CORRIGIDA =====
        function showContractModal(providedCode = null, providedTitle = null) {
            console.log('üöÄ showContractModal executada!', { 
                providedCode: !!providedCode, 
                providedTitle,
                appState: !!window.AppState 
            });
            
            const tokenData = window.AppState?.tokenData;
            let contractCode = '';
            let modalTitle = 'Contrato Solidity';
            
            // Se forneceu c√≥digo, usar diretamente
            if (providedCode) {
                contractCode = providedCode;
                modalTitle = providedTitle || 'Contrato Solidity';
            } else {
                // Verificar dados do token
                if (!tokenData?.name || !tokenData?.symbol) {
                    console.error('‚ùå Dados do token n√£o encontrados');
                    alert('Dados do token n√£o encontrados. Certifique-se de que AppState.tokenData est√° configurado.');
                    return;
                }
                
                modalTitle = `Contrato: ${tokenData.symbol}`;
                
                // Usar c√≥digo do deploy se dispon√≠vel
                if (window.AppState.deployResult?.sourceCode) {
                    contractCode = window.AppState.deployResult.sourceCode;
                    modalTitle = `Contrato Deployado: ${tokenData.symbol}`;
                    console.log('üìÑ Usando c√≥digo do deploy');
                } else {
                    // Fallback para contrato b√°sico
                    contractCode = `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

contract ${tokenData.symbol} {
    string public name = "${tokenData.name}";
    string public symbol = "${tokenData.symbol}";
    uint8 public decimals = ${tokenData.decimals || 18};
    uint256 public totalSupply = ${tokenData.totalSupply} * 10**${tokenData.decimals || 18};
    
    mapping(address => uint256) public balanceOf;
    
    event Transfer(address indexed from, address indexed to, uint256 value);
    
    constructor() {
        balanceOf[msg.sender] = totalSupply;
        emit Transfer(address(0), msg.sender, totalSupply);
    }
    
    function transfer(address to, uint256 value) public returns (bool) {
        require(balanceOf[msg.sender] >= value, "Saldo insuficiente");
        balanceOf[msg.sender] -= value;
        balanceOf[to] += value;
        emit Transfer(msg.sender, to, value);
        return true;
    }
}`;
                    console.log('üìÑ Usando contrato fallback');
                }
            }
            
            // Criar modal com Bootstrap
            const modalId = 'contractModal-' + Date.now();
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = modalId;
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content bg-dark text-white">
                        <div class="modal-header border-secondary">
                            <h5 class="modal-title">
                                <i class="bi bi-file-earmark-code me-2"></i>${modalTitle}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted">C√≥digo fonte do contrato</small>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="copyCode('${modalId}')">
                                        <i class="bi bi-clipboard me-1"></i>Copiar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadCode('${modalId}')">
                                        <i class="bi bi-download me-1"></i>Baixar
                                    </button>
                                </div>
                            </div>
                            <pre id="contract-code-${modalId}" class="bg-black text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 11px; line-height: 1.3;">${contractCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior
            document.querySelectorAll('[id^="contractModal-"]').forEach(m => m.remove());
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            console.log('‚úÖ Modal criada e exibida com sucesso!');
            updateStatus('Modal do contrato aberta com sucesso!', 'success');
            
            // Remover ap√≥s fechar
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }
        
        // Fun√ß√µes auxiliares do modal
        window.copyCode = function(modalId) {
            const codeEl = document.getElementById('contract-code-' + modalId);
            if (codeEl) {
                navigator.clipboard.writeText(codeEl.textContent).then(() => {
                    console.log('‚úÖ C√≥digo copiado!');
                    alert('C√≥digo copiado!');
                });
            }
        };
        
        window.downloadCode = function(modalId) {
            const codeEl = document.getElementById('contract-code-' + modalId);
            if (codeEl) {
                const code = codeEl.textContent;
                const blob = new Blob([code], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = (window.AppState?.tokenData?.symbol || 'Contract') + '.sol';
                a.click();
                URL.revokeObjectURL(url);
                console.log('‚úÖ Arquivo baixado!');
            }
        };
        
        // ===== FUN√á√ïES DE TESTE =====
        function testarFuncaoShowContract() {
            console.log('üß™ Testando fun√ß√£o showContractModal...');
            updateStatus('Testando fun√ß√£o showContractModal...', 'info');
            
            try {
                showContractModal();
                updateStatus('Fun√ß√£o executada com sucesso!', 'success');
            } catch (error) {
                console.error('‚ùå Erro na fun√ß√£o:', error);
                updateStatus('Erro na fun√ß√£o: ' + error.message, 'error');
            }
        }
        
        function verificarBotaoDOM() {
            console.log('üîç Verificando bot√£o no DOM...');
            const btn = document.getElementById('view-contract-btn');
            
            if (btn) {
                console.log('‚úÖ Bot√£o encontrado!');
                console.log('   - ID:', btn.id);
                console.log('   - Classes:', btn.className);
                console.log('   - Texto:', btn.textContent.trim());
                console.log('   - Disabled:', btn.disabled);
                console.log('   - Display:', btn.style.display);
                console.log('   - Onclick:', !!btn.onclick);
                updateStatus('Bot√£o encontrado e analisado!', 'success');
            } else {
                console.error('‚ùå Bot√£o n√£o encontrado!');
                updateStatus('Bot√£o n√£o encontrado no DOM!', 'error');
            }
        }
        
        function configurarBotao() {
            console.log('üîß Configurando bot√£o...');
            const btn = document.getElementById('view-contract-btn');
            
            if (!btn) {
                console.error('‚ùå Bot√£o n√£o encontrado!');
                updateStatus('Bot√£o n√£o encontrado!', 'error');
                return;
            }
            
            // Limpar configura√ß√£o anterior
            btn.onclick = null;
            
            // Configurar nova funcionalidade
            btn.onclick = function(e) {
                console.log('üñ±Ô∏è CLIQUE DETECTADO!');
                e.preventDefault();
                
                try {
                    showContractModal();
                } catch (error) {
                    console.error('‚ùå Erro ao executar showContractModal:', error);
                    alert('Erro: ' + error.message);
                }
            };
            
            // Garantir que est√° habilitado
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'all';
            
            console.log('‚úÖ Bot√£o configurado com sucesso!');
            updateStatus('Bot√£o configurado! Teste clicando nele.', 'success');
        }
        
        function testeCompleto() {
            console.log('üß™ === INICIANDO TESTE COMPLETO ===');
            updateStatus('Executando teste completo...', 'info');
            
            // Passo 1
            console.log('1. Verificando fun√ß√£o...');
            if (typeof showContractModal !== 'function') {
                console.error('‚ùå Fun√ß√£o n√£o existe!');
                updateStatus('Erro: Fun√ß√£o n√£o existe!', 'error');
                return;
            }
            
            // Passo 2
            console.log('2. Verificando bot√£o...');
            const btn = document.getElementById('view-contract-btn');
            if (!btn) {
                console.error('‚ùå Bot√£o n√£o existe!');
                updateStatus('Erro: Bot√£o n√£o existe!', 'error');
                return;
            }
            
            // Passo 3
            console.log('3. Configurando bot√£o...');
            configurarBotao();
            
            // Passo 4
            console.log('4. Testando fun√ß√£o...');
            try {
                showContractModal();
                console.log('‚úÖ Fun√ß√£o funciona!');
            } catch (error) {
                console.error('‚ùå Erro na fun√ß√£o:', error);
                updateStatus('Erro na fun√ß√£o: ' + error.message, 'error');
                return;
            }
            
            // Passo 5
            console.log('5. Simulando clique...');
            setTimeout(() => {
                try {
                    btn.click();
                    console.log('‚úÖ Clique simulado com sucesso!');
                    updateStatus('‚úÖ TESTE COMPLETO CONCLU√çDO COM SUCESSO!', 'success');
                } catch (error) {
                    console.error('‚ùå Erro no clique:', error);
                    updateStatus('Erro no clique: ' + error.message, 'error');
                }
            }, 1000);
        }
        
        // ===== INICIALIZA√á√ÉO =====
        console.log('‚úÖ Sistema de teste carregado!');
        console.log('üéØ AppState configurado:', !!window.AppState);
        updateStatus('Sistema pronto para testes!', 'success');
        
        // Auto-configurar bot√£o ap√≥s load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('üîÑ Auto-configurando bot√£o...');
                configurarBotao();
            }, 500);
        });
    </script>
</body>
</html>
