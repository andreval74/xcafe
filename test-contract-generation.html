<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Gera√ß√£o de Contratos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .error {
            color: #ff6b6b;
        }
        
        .success {
            color: #51cf66;
        }
    </style>
</head>
<body>
    <h1>üß™ Teste de Gera√ß√£o de Contratos xcafe</h1>
    
    <div class="test-section">
        <h2>Dados de Teste</h2>
        <p><strong>Nome:</strong> TestCoin</p>
        <p><strong>S√≠mbolo:</strong> TEST</p>
        <p><strong>Supply:</strong> 1000000</p>
        <p><strong>Owner:</strong> 0x742d35Cc6623C29Dd2022f0c0d4e4a3a9E87B7B4</p>
        
        <button onclick="testContractGeneration()">üöÄ Testar Gera√ß√£o</button>
        <button onclick="downloadTest()">üì• Download Teste</button>
        <button onclick="previewTest()">üëÅÔ∏è Preview Teste</button>
    </div>
    
    <div class="test-section">
        <h2>Resultado</h2>
        <div id="result"></div>
        <pre id="contract-output"></pre>
    </div>

    <script>
        // Mock do AppState para teste
        const AppState = {
            wallet: {
                connected: true,
                address: '0x742d35Cc6623C29Dd2022f0c0d4e4a3a9E87B7B4',
                network: {
                    name: 'Ethereum Mainnet'
                }
            },
            tokenData: {
                name: 'TestCoin',
                symbol: 'TEST',
                totalSupply: '1000000',
                owner: '0x742d35Cc6623C29Dd2022f0c0d4e4a3a9E87B7B4',
                decimals: '18'
            }
        };

        // Fun√ß√£o para carregar o template base.sol
        async function loadSolidityTemplate() {
            try {
                const response = await fetch('./contratos/base.sol');
                if (!response.ok) {
                    throw new Error('N√£o foi poss√≠vel carregar o template base.sol');
                }
                return await response.text();
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar template base.sol, usando template interno:', error);
                // Template de fallback b√°sico caso n√£o consiga carregar o base.sol
                return `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

/*
Gerado por:
Smart Contract Cafe - Fallback Template
https://smartcontract.cafe
*/

// CONFIGURA√á√ïES DO TOKEN
string constant TOKEN_NAME = "{{TOKEN_NAME}}";
string constant TOKEN_SYMBOL = "{{TOKEN_SYMBOL}}";
uint8 constant TOKEN_DECIMALS = {{DECIMALS}};
uint256 constant TOKEN_SUPPLY = {{TOKEN_SUPPLY}};
address constant TOKEN_OWNER = {{OWNER_ADDRESS}};
string constant TOKEN_LOGO_URI = "{{TOKEN_LOGO_URI}}";
address constant BTCBR_ORIGINAL = {{TOKEN_ORIGINAL}};

// Contrato ERC-20 b√°sico
contract {{TOKEN_SYMBOL}} {
    string public name = TOKEN_NAME;
    string public symbol = TOKEN_SYMBOL;
    uint8 public decimals = TOKEN_DECIMALS;
    uint256 public totalSupply = TOKEN_SUPPLY * (10 ** uint256(decimals));
    
    mapping(address => uint256) private _balances;
    mapping(address => mapping(address => uint256)) private _allowances;
    
    event Transfer(address indexed from, address indexed to, uint256 value);
    event Approval(address indexed owner, address indexed spender, uint256 value);
    
    constructor() {
        _balances[TOKEN_OWNER] = totalSupply;
        emit Transfer(address(0), TOKEN_OWNER, totalSupply);
    }
    
    function balanceOf(address account) public view returns (uint256) {
        return _balances[account];
    }
    
    function transfer(address recipient, uint256 amount) public returns (bool) {
        require(_balances[msg.sender] >= amount, "Insufficient balance");
        _balances[msg.sender] -= amount;
        _balances[recipient] += amount;
        emit Transfer(msg.sender, recipient, amount);
        return true;
    }
}

/*
Template de fallback gerado pelo xcafe Token Creator
https://xcafe.com
*/`;
            }
        }

        // Gera contrato Solidity usando template base.sol
        async function generateSolidityContract(tokenData) {
            try {
                // Carregar template base.sol
                const template = await loadSolidityTemplate();
                
                // Substituir vari√°veis do template
                const contractCode = template
                    .replace(/{{TOKEN_NAME}}/g, tokenData.name)
                    .replace(/{{TOKEN_SYMBOL}}/g, tokenData.symbol)
                    .replace(/{{DECIMALS}}/g, tokenData.decimals || '18')
                    .replace(/{{TOKEN_SUPPLY}}/g, tokenData.totalSupply)
                    .replace(/{{OWNER_ADDRESS}}/g, tokenData.owner)
                    .replace(/{{TOKEN_LOGO_URI}}/g, '') // Logo URI vazio por padr√£o
                    .replace(/{{TOKEN_ORIGINAL}}/g, '0x80c09daC9dC95669B03C2d82967Af62e93d0Fe84'); // Endere√ßo BTCBR em checksum correto
                    
                console.log('‚úÖ Contrato Solidity gerado com sucesso usando template base.sol');
                return contractCode;
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar contrato Solidity:', error);
                throw error;
            }
        }

        // Testa a gera√ß√£o de contrato
        async function testContractGeneration() {
            const result = document.getElementById('result');
            const output = document.getElementById('contract-output');
            
            try {
                result.innerHTML = '<span class="success">‚è≥ Gerando contrato...</span>';
                
                const contractCode = await generateSolidityContract(AppState.tokenData);
                
                result.innerHTML = '<span class="success">‚úÖ Contrato gerado com sucesso!</span>';
                output.textContent = contractCode;
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Erro: ${error.message}</span>`;
                output.textContent = '';
            }
        }

        // Testa download
        async function downloadTest() {
            try {
                const contractCode = await generateSolidityContract(AppState.tokenData);
                const fileName = `${AppState.tokenData.symbol}.sol`;
                
                // Criar blob e download
                const blob = new Blob([contractCode], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                
                // Criar link tempor√°rio para download
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = fileName;
                downloadLink.style.display = 'none';
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                window.URL.revokeObjectURL(url);
                
                document.getElementById('result').innerHTML = '<span class="success">‚úÖ Download iniciado!</span>';
                
            } catch (error) {
                document.getElementById('result').innerHTML = `<span class="error">‚ùå Erro no download: ${error.message}</span>`;
            }
        }

        // Testa preview
        async function previewTest() {
            try {
                const contractCode = await generateSolidityContract(AppState.tokenData);
                
                // Criar modal simples
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
                    justify-content: center; align-items: center;
                `;
                
                modal.innerHTML = `
                    <div style="background: #2a2a2a; padding: 20px; border-radius: 10px; max-width: 80%; max-height: 80%; overflow: auto;">
                        <h3>Preview: ${AppState.tokenData.symbol}.sol</h3>
                        <pre style="background: #000; padding: 15px; border-radius: 5px; overflow: auto;">${contractCode}</pre>
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 10px;">Fechar</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                document.getElementById('result').innerHTML = '<span class="success">‚úÖ Preview aberto!</span>';
                
            } catch (error) {
                document.getElementById('result').innerHTML = `<span class="error">‚ùå Erro no preview: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
