/**
 * SISTEMA DE WALLET PARA HEADER - xcafe
 * Sistema completo de conex√£o MetaMask integrado ao header
 * 
 * ‚úÖ FUNCIONALIDADES:
 * - Conex√£o/desconex√£o autom√°tica
 * - Detec√ß√£o de rede e chain ID  
 * - Verifica√ß√£o de status ao carregar
 * - Interface responsiva
 * - Event listeners para mudan√ßas
 * - Atualiza√ß√£o em tempo real
 */

class WalletHeader {
    constructor() {
        this.isConnected = false;
        this.userAddress = null;
        this.currentNetwork = null;
        this.connectButton = null;
        this.walletText = null;
        
        this.init();
    }

    /**
     * Inicializa o sistema
     */
    init() {
        console.log('üöÄ Inicializando Wallet Header System...');
        
        // Aguardar DOM estar pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.setupElements());
        } else {
            this.setupElements();
        }
    }

    /**
     * Configura elementos DOM
     */
    setupElements() {
        // Procurar por container da wallet
        const walletContainer = document.getElementById('wallet-container');
        
        if (!walletContainer) {
            console.log('‚ö†Ô∏è Container da wallet n√£o encontrado ainda...');
            setTimeout(() => this.setupElements(), 1000);
            return;
        }
        
        // Criar bot√£o da wallet dinamicamente
        this.createWalletButton(walletContainer);
        
        console.log('‚úÖ Elementos encontrados, configurando eventos...');
        
        // Event listener para bot√£o
        this.connectButton.addEventListener('click', () => this.handleWalletClick());
        
        // Verificar se j√° est√° conectado
        this.checkConnection();
        
        // Setup event listeners do MetaMask
        this.setupMetaMaskEvents();
    }

    /**
     * Cria o bot√£o da wallet dinamicamente
     */
    createWalletButton(container) {
        // Limpar container
        container.innerHTML = '';
        
        // Criar bot√£o
        this.connectButton = document.createElement('button');
        this.connectButton.className = 'btn btn-outline-primary me-2';
        this.connectButton.id = 'connectWallet';
        
        // Criar √≠cone
        const icon = document.createElement('i');
        icon.className = 'bi bi-wallet2 me-1';
        
        // Criar texto
        this.walletText = document.createElement('span');
        this.walletText.textContent = 'Conectar Wallet';
        this.walletText.id = 'walletText';
        
        // Montar bot√£o
        this.connectButton.appendChild(icon);
        this.connectButton.appendChild(this.walletText);
        
        // Adicionar ao container
        container.appendChild(this.connectButton);
        
        // Adicionar dropdown de tradu√ß√£o se necess√°rio
        this.addTranslateDropdown(container);
        
        console.log('‚úÖ Bot√£o da wallet criado dinamicamente');
    }

    /**
     * Adiciona dropdown de tradu√ß√£o
     */
    addTranslateDropdown(container) {
        const dropdownDiv = document.createElement('div');
        dropdownDiv.className = 'dropdown';
        
        const dropdownButton = document.createElement('button');
        dropdownButton.className = 'btn btn-outline-secondary dropdown-toggle';
        dropdownButton.type = 'button';
        dropdownButton.setAttribute('data-bs-toggle', 'dropdown');
        dropdownButton.setAttribute('aria-expanded', 'false');
        
        const globeIcon = document.createElement('i');
        globeIcon.className = 'bi bi-globe';
        dropdownButton.appendChild(globeIcon);
        
        const dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu dropdown-menu-end';
        dropdownMenu.setAttribute('data-component', 'translate-component');
        
        dropdownDiv.appendChild(dropdownButton);
        dropdownDiv.appendChild(dropdownMenu);
        container.appendChild(dropdownDiv);
    }

    /**
     * Handle do clique no bot√£o
     */
    async handleWalletClick() {
        if (this.isConnected) {
            this.disconnect();
        } else {
            await this.connect();
        }
    }

    /**
     * Conecta com MetaMask
     */
    async connect() {
        if (!window.ethereum) {
            this.showError('MetaMask n√£o encontrado! Por favor, instale o MetaMask.');
            return;
        }

        try {
            this.setLoading(true);
            
            console.log('üîó Conectando com MetaMask...');
            
            const accounts = await window.ethereum.request({ 
                method: 'eth_requestAccounts' 
            });
            
            if (accounts.length > 0) {
                this.userAddress = accounts[0];
                this.isConnected = true;
                
                // Obter informa√ß√µes da rede
                await this.getNetworkInfo();
                
                // Atualizar interface
                this.updateUI();
                
                console.log('‚úÖ Wallet conectada:', this.userAddress);
                console.log('üåç Rede:', this.currentNetwork);
                
            } else {
                throw new Error('Nenhuma conta encontrada');
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao conectar wallet:', error);
            this.showError('Erro ao conectar: ' + error.message);
        } finally {
            this.setLoading(false);
        }
    }

    /**
     * Desconecta wallet
     */
    disconnect() {
        this.isConnected = false;
        this.userAddress = null;
        this.currentNetwork = null;
        this.updateUI();
        console.log('üîå Wallet desconectada');
    }

    /**
     * Verifica se j√° est√° conectado
     */
    async checkConnection() {
        if (!window.ethereum) return;
        
        try {
            const accounts = await window.ethereum.request({ 
                method: 'eth_accounts' 
            });
            
            if (accounts.length > 0) {
                this.userAddress = accounts[0];
                this.isConnected = true;
                await this.getNetworkInfo();
                this.updateUI();
                console.log('‚úÖ Reconectado automaticamente:', this.userAddress);
            }
        } catch (error) {
            console.log('‚ö†Ô∏è N√£o foi poss√≠vel verificar conex√£o:', error.message);
        }
    }

    /**
     * Obt√©m informa√ß√µes da rede
     */
    async getNetworkInfo() {
        if (!window.ethereum) return;
        
        try {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            const networkInfo = this.getNetworkName(chainId);
            this.currentNetwork = networkInfo;
        } catch (error) {
            console.log('‚ö†Ô∏è Erro ao obter info da rede:', error);
            this.currentNetwork = { name: 'Desconhecida', chainId: 'unknown' };
        }
    }

    /**
     * Obt√©m nome da rede pelo Chain ID
     */
    getNetworkName(chainId) {
        const networks = {
            '0x1': { name: 'Ethereum Mainnet', chainId: '1' },
            '0x38': { name: 'BSC Mainnet', chainId: '56' },
            '0x61': { name: 'BSC Testnet', chainId: '97' },
            '0x89': { name: 'Polygon', chainId: '137' },
            '0xaa36a7': { name: 'Sepolia Testnet', chainId: '11155111' },
            '0x2105': { name: 'Base Mainnet', chainId: '8453' }
        };
        
        return networks[chainId] || { name: `Chain ${chainId}`, chainId };
    }

    /**
     * Atualiza interface do usu√°rio
     */
    updateUI() {
        if (!this.connectButton || !this.walletText) return;
        
        if (this.isConnected && this.userAddress) {
            // Endere√ßo abreviado
            const shortAddress = `${this.userAddress.substring(0, 6)}...${this.userAddress.substring(38)}`;
            
            // Atualizar texto e estilo
            this.walletText.textContent = shortAddress;
            this.connectButton.classList.remove('btn-outline-primary');
            this.connectButton.classList.add('btn-success');
            this.connectButton.title = `Conectado √† ${this.currentNetwork?.name || 'rede desconhecida'}\nClique para desconectar`;
            
            // Adicionar badge da rede
            const icon = this.connectButton.querySelector('i');
            if (icon) {
                icon.className = 'bi bi-check-circle me-1';
            }
            
        } else {
            // Estado desconectado
            this.walletText.textContent = 'Conectar Wallet';
            this.connectButton.classList.remove('btn-success');
            this.connectButton.classList.add('btn-outline-primary');
            this.connectButton.title = 'Conectar com MetaMask';
            
            const icon = this.connectButton.querySelector('i');
            if (icon) {
                icon.className = 'bi bi-wallet2 me-1';
            }
        }
    }

    /**
     * Define estado de loading
     */
    setLoading(loading) {
        if (!this.connectButton || !this.walletText) return;
        
        if (loading) {
            this.walletText.textContent = 'Conectando...';
            this.connectButton.disabled = true;
            
            const icon = this.connectButton.querySelector('i');
            if (icon) {
                icon.className = 'bi bi-hourglass-split me-1';
            }
        } else {
            this.connectButton.disabled = false;
        }
    }

    /**
     * Mostra mensagem de erro
     */
    showError(message) {
        console.error('üö®', message);
        
        // Toast ou alert simples
        if (window.bootstrap && window.bootstrap.Toast) {
            // Se Bootstrap estiver dispon√≠vel, usar toast
            this.showToast(message, 'error');
        } else {
            // Fallback para alert
            alert(message);
        }
    }

    /**
     * Configura event listeners do MetaMask
     */
    setupMetaMaskEvents() {
        if (!window.ethereum) return;
        
        // Mudan√ßa de conta
        window.ethereum.on('accountsChanged', (accounts) => {
            console.log('üë§ Conta alterada:', accounts);
            if (accounts.length > 0) {
                this.userAddress = accounts[0];
                this.isConnected = true;
                this.updateUI();
            } else {
                this.disconnect();
            }
        });
        
        // Mudan√ßa de rede
        window.ethereum.on('chainChanged', (chainId) => {
            console.log('üåç Rede alterada:', chainId);
            this.getNetworkInfo().then(() => this.updateUI());
        });
        
        // Desconex√£o
        window.ethereum.on('disconnect', () => {
            console.log('üîå MetaMask desconectado');
            this.disconnect();
        });
    }

    /**
     * Obt√©m informa√ß√µes da wallet (p√∫blico)
     */
    getWalletInfo() {
        return {
            isConnected: this.isConnected,
            address: this.userAddress,
            network: this.currentNetwork
        };
    }
}

// ==================== INICIALIZA√á√ÉO GLOBAL ====================

// Instanciar sistema quando script carregar
const walletHeader = new WalletHeader();

// Expor globalmente para outras partes da aplica√ß√£o
window.WalletHeader = walletHeader;

// Event customizado quando wallet conectar
document.addEventListener('walletConnected', (event) => {
    console.log('üéâ Wallet conectada globalmente:', event.detail);
});

console.log('üì¶ Wallet Header System carregado');
